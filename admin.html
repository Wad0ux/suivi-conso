<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Tableau de bord</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
  <h1 class="text-3xl mb-6">Tableau de bord consommation</h1>
  <table class="min-w-full bg-white rounded shadow">
    <thead>
      <tr>
        <th class="py-2 px-4 border">Nom</th>
        <th class="py-2 px-4 border">Canette</th>
        <th class="py-2 px-4 border">Nourriture</th>
        <th class="py-2 px-4 border">Total</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script type="module">
    import { db } from './firebase.js';
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function loadData() {
      const consommationsSnapshot = await getDocs(collection(db, "consommations"));
      const data = {};

      consommationsSnapshot.forEach(doc => {
        const { client, produit, quantite } = doc.data();

        if (!data[client]) {
          data[client] = { "Canette": 0, "Nourriture": 0, total: 0 };
        }
        data[client][produit] = (data[client][produit] || 0) + quantite;
        data[client].total += quantite;
      });

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      for (const client in data) {
        const row = document.createElement('tr');
        row.classList.add('text-center', 'border-t');

        row.innerHTML = `
          <td class="py-2 px-4 border">${client}</td>
          <td class="py-2 px-4 border">${data[client]["Canette"] || 0}</td>
          <td class="py-2 px-4 border">${data[client]["Nourriture"] || 0}</td>
          <td class="py-2 px-4 border font-bold">${data[client].total}</td>
        `;

        tbody.appendChild(row);
      }
    }
    // Fonction simple pour exporter le tableau en CSV
    function exportTableToCSV(filename) {
      const rows = document.querySelectorAll('table tr');
      const csv = [];

      for (const row of rows) {
        const cols = row.querySelectorAll('th, td');
        const rowData = [];
        cols.forEach(col => {
          // Échapper les doubles quotes et entourer chaque champ de doubles quotes
          let data = col.innerText.replace(/"/g, '""');
          rowData.push(`"${data}"`);
        });
        csv.push(rowData.join(','));
      }

      // Création du fichier CSV et téléchargement
      const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
      const downloadLink = document.createElement('a');
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
    loadData();
  </script>
</body>
</html>
